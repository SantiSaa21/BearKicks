format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: android

workflows:
  primary:
    envs:
      - CI: "true"                      # Ensures build scripts detect CI
      - GOOGLE_SERVICES_SKIP_VERIFY: "true"  # Skip strict google-services check in unit tests
      # Optionally provide your google-services.json via Base64 secret
      # - GOOGLE_SERVICES_JSON_B64: "(set in Bitrise Secrets)"
    steps:
      - git-clone: {}
      - cache-pull: {}
      - install-missing-android-tools:
          inputs:
            - gradlew_path: "./gradlew"
            - api_level: "34"          # Lower for faster tool install; compileSdk=36 still works with build-tools superset
            - build_tools: "34.0.0"
            - ndk_revision: ""
      - script:
          title: Restore google-services.json (if provided)
          inputs:
            - content: |-
                if [ -n "$GOOGLE_SERVICES_JSON_B64" ]; then
                  echo "$GOOGLE_SERVICES_JSON_B64" | base64 --decode > app/google-services.json
                  echo "google-services.json restored from secret"
                else
                  # Crear stub mÃ­nimo para que el plugin no falle
                  cat > app/google-services.json <<'EOF'
                  {
                    "project_info": {
                      "project_number": "123456789012",
                      "project_id": "stub-project",
                      "storage_bucket": "stub-project.appspot.com"
                    },
                    "client": [
                      {
                        "client_info": {
                          "mobilesdk_app_id": "1:123456789012:android:stubstubstub",
                          "android_client_info": {"package_name": "com.bearkicks.app"}
                        },
                        "oauth_client": [],
                        "api_key": [{"current_key": "STUB_KEY"}],
                        "services": {"appinvite_service": {"other_platform_oauth_client": []}}
                      }
                    ],
                    "configuration_version": "1"
                  }
                  EOF
                  echo "Stub google-services.json generated"
                fi
      - script:
          title: Gradle unit tests (debug)
          inputs:
            - content: |-
                ./gradlew testDebugUnitTest --stacktrace
      - android-build:
          title: Assemble release AAB
          inputs:
            - module: app
            - variant: release
      - cache-push: {}
      - deploy-to-bitrise-io:
          inputs:
            - notify_user_groups: ''
            - notify_email_list: ''

  run_tests:
    envs:
      - CI: "true"
      - GOOGLE_SERVICES_SKIP_VERIFY: "true"
    steps:
      - git-clone: {}
      - cache-pull: {}
      - install-missing-android-tools:
          inputs:
            - gradlew_path: "./gradlew"
            - api_level: "34"
            - build_tools: "34.0.0"
      - script:
          title: Unit tests (disable firebase plugin)
          inputs:
            - content: |-
                ./gradlew :app:testDebugUnitTest -PdisableFirebase --stacktrace
      - cache-push: {}
      - deploy-to-bitrise-io:
          inputs:
            - notify_user_groups: ''
            - notify_email_list: ''

app:
  envs:
    - BITRISE_DISTRIBUTION_METHOD: "none"
